# π“– λ™μ‹μ„± μ΄μ/μ„¤κ³„

## 1οΈβƒ£ μΆμ„ μμ•½ μ‹ μ¤‘λ³µ μμ•½ λ°μƒ κ°€λ¥

### λ¬Έμ  μƒν™© λ° λ‚΄λ¶€ κµ¬μ΅°

- λ™μ‹μ— μ—¬λ¬λ…μ΄ μΆμ„ μμ•½ μ”μ²­ μ‹ μ¤‘λ³µ μμ•½μ΄ μƒκΈΈ μ μλ‹¤.
- μ μ € μ‹λ³„μμ™€ μΆμ„ μ‹λ³„μλ΅ μμ•½ λ°μ΄ν„°(μ„μ‹λ°°μ • μƒνƒ)λ¥Ό INSERT ν•κ³  μλ‹¤.
- μμ•½ λ°μ΄ν„° INSERT μ „μ— μΆμ„ μ‹λ³„μλ΅ μμ•½ λ°μ΄ν„° Double Check ν•κ³  μλ‹¤.

### ν•΄κ²° μ „λµ

- λ°μ΄ν„° μ •ν•©μ„±μ΄ μ¤‘μ”ν•κ³  μΈκΈ° μΆμ„μΌ κ²½μ° μ¶©λμ΄ λ§μ•„μ§ μ μμ–΄ λΉ„κ΄€μ  λ½μΌλ΅ μ„¤μ •
  - **DB Lock : λΉ„κ΄€μ  λ½**
- νΈλμ­μ… κ²©λ¦¬ μμ¤€μ€ μ²μ ν•λ² μ΅°νν•μ—¬ μ¤‘λ³µ μ²΄ν¬λ§ ν•λ―€λ΅ READ COMMITTED λ΅ μ„¤μ •
  - **νΈλμ­μ… κ²©λ¦¬ μμ¤€ : READ COMMITED**
- λ°λ“λ½ λ°©μ§€
  - **νΈλμ­μ… νƒ€μ„μ•„μ›ƒ 10μ΄ μ„¤μ •**

### ν…μ¤νΈ κ²°κ³Ό
- μƒμ„Έ ν…μ¤νΈ μ½”λ“
  - [ReservationConcurrencyTest.java](../src/test/java/kr/hhplus/be/server/integration/concurrency/ReservationConcurrencyTest.java)
    - λ™μ‹μ— μ—¬λ¬λ…μ΄ ν•λ‚μ μΆμ„ μμ•½ μ”μ²­ μ‹ ν• λ…λ§ μ„±κ³µν•λ‹¤
    - λ™μ‹μ— μ—¬λ¬λ…μ΄ μ—¬λ¬κ°μ μΆμ„μ— κ°κ° μμ•½ μ”μ²­ μ‹ ν• λ…μ”©λ§ μ„±κ³µν•λ‹¤
- κ²°κ³Ό
  ![img.png](img/reservation-concurrency-test.png)

---

## 2οΈβƒ£ ν¬μΈνΈ μ”μ•΅ μ°¨κ° μ‹ μμ μ”μ•΅ λ°μƒ κ°€λ¥
### λ¬Έμ  μƒν™© λ° λ‚΄λ¶€ κµ¬μ΅°

- λ™μ‹ μ—¬λ¬ ν¬μΈνΈ μ‚¬μ© μ”μ²­ μ‹ μ”μ•΅ μ΅°ν -> κ³„μ‚° -> κ°±μ‹  κ³Όμ • μ¤‘ ν¬μΈνΈ μ”μ•΅μ΄ μμκ°€ λ°μƒν•  μ μλ‹¤.
- μ μ € μ •λ³΄μ—μ„ ν¬μΈνΈ μ΅°ν ν›„ μ”μ—¬ ν¬μΈνΈ - μ‚¬μ© ν¬μΈνΈ κ³„μ‚° ν›„ μ”μ•΅μ„ UPDATE ν•λ‹¤.
- μ μ € λ„λ©”μΈμ—μ„ μ”μ—¬ ν¬μΈνΈκ°€ μ‚¬μ© ν¬μΈνΈλ³΄λ‹¤ μ‘μΌλ©΄ μμ™Έκ°€ λ°μƒν•λ„λ΅ λ΅μ§μ΄ ν¬ν•¨λμ–΄ μλ‹¤.

### ν•΄κ²° μ „λµ

- ν¬μΈνΈ μ‚¬μ©μ”μ²­μ€ μ¶©λμ΄ λ§μ§€ μ•μ•„ λ‚™κ΄€μ  λ½μΌλ΅ μ„¤μ •
  - **DB Lock : λ‚™κ΄€μ  λ½**
- νΈλμ­μ… κ²©λ¦¬ μμ¤€μ€ μ²μ ν•λ² μ΅°νλ§ ν•λ―€λ΅ Dirty Read λ§ λ°©μ§€, READ COMMITTED λ΅ μ„¤μ •
  - **νΈλμ­μ… κ²©λ¦¬ μμ¤€ : READ COMMITED**
- λ°λ“λ½ λ°©μ§€
  - **λ‚™κ΄€μ  λ½ μ‚¬μ©μΌλ΅ λ°μ΄ν„°μ μ κΈμ΄ μµμ†ν™” λμ–΄ νƒ€μ„μ•„μ›ƒ μƒλµ**

### ν…μ¤νΈ κ²°κ³Ό
- μƒμ„Έ ν…μ¤νΈ μ½”λ“
  - [PointConcurrencyTest.java](../src/test/java/kr/hhplus/be/server/integration/concurrency/PointConcurrencyTest.java)
    - λ™μ‹μ— μ—¬λ¬ ν¬μΈνΈ μ‚¬μ© μ”μ²­ μ‹ μ”μ—¬ ν¬μΈνΈλ” 0κ³Ό κ°™κ±°λ‚ μ»¤μ•Όν•λ‹¤.
- κ²°κ³Ό
  ![img.png](img/point-concurrency-test.png)
---

## 3οΈβƒ£ μΆμ„ μ„μ‹ λ°°μ • ν•΄μ  μ¤μΌ€μ¤„λ¬ μ‹¤ν–‰ μ‹ λ°μ΄ν„° μ •ν•©μ„± λ¬Έμ 
### λ¬Έμ  μƒν™© λ° λ‚΄λ¶€ κµ¬μ΅°

- μΆμ„ μ„μ‹ λ°°μ • ν•΄μ  μ¤μΌ€μ¤„λ¬μ—μ„ μ„μ‹λ°°μ • μƒνƒλ¥Ό ν•΄μ ν•λ” κ³Όμ •μ—μ„ κ²°μ μ™€ λ™μ‹ μ‹¤ν–‰ μ‹ κ²°μ  μ™„λ£λ κ±΄λ“¤λ„ μ¤μΌ€μ¤„λ¬μ—μ„ μ·¨μ† μ²λ¦¬ μ‹ν‚¬ κ°€λ¥μ„±μ΄ μ΅΄μ¬ν•λ‹¤.
- μ„μ‹λ°°μ • ν•΄μ  μ¤μΌ€μ¤„λ¬λ” μμ•½ μƒνƒκ°€ HOLD(μ„μ‹λ°°μ •) μΈ μμ•½ κ±΄λ“¤μ„ μ΅°ν ν›„ Redis μ—μ„ TTL(5λ¶„)λ΅ λ§λ£λ κ±΄λ“¤μ„ μ·¨μ† μƒνƒλ΅ UPDATE
- κ²°μ  μ§„ν–‰ μ‹ μμ•½ μƒνƒκ°€ HOLD(μ„μ‹λ°°μ •) μ΄κ³  Redis μ— μ΅΄μ¬ν•λ”μ§€ μ²΄ν¬ν•κ³  ν¬μΈνΈ μ°¨κ° ν›„ COMPLETED(μ™„λ£) μƒνƒλ΅ UPDATE

### ν•΄κ²° μ „λµ

- ν•λ‚μ μμ•½ κ±΄μ— λ€ν•μ—¬ μ„μ‹λ°°μ • ν•΄μ  μ¤μΌ€μ¤„λ¬μ™€ κ²°μ  μ§„ν–‰μ΄ μ¶©λλ  κ²½μ°κ°€ λ‚®μ•„ μ΅°κ±΄λ¶€ UPDATE λ΅ λ™μ‹μ„± μ μ–΄
  - **μ΅°κ±΄λ¶€ UPDATE**
- νΈλμ­μ… κ²©λ¦¬ μμ¤€μ€ μ„μ‹λ°°μ •μΈ κ±΄λ“¤μ„ μ²μ ν•λ² μ΅°νλ§ ν•λ―€λ΅ Dirty Read λ§ λ°©μ§€, READ COMMITTED λ΅ μ„¤μ •
  - **νΈλμ­μ… κ²©λ¦¬ μμ¤€ : READ COMMITED**
- λ°λ“λ½ λ°©μ§€
  - **μ΅°κ±΄λ¶€ UPDATE μ‚¬μ©μΌλ΅ λ°μ΄ν„°μ μ κΈμ΄ μµμ†ν™” λμ–΄ νƒ€μ„μ•„μ›ƒ μƒλµ**

### ν…μ¤νΈ κ²°κ³Ό
- μƒμ„Έ ν…μ¤νΈ μ½”λ“
  - [ReservationExpirationConcurrencyTest](../src/test/java/kr/hhplus/be/server/integration/concurrency/ReservationExpirationConcurrencyTest.java)
    - λ™μ‹μ— μ—¬λ¬ ν¬μΈνΈ μ‚¬μ© μ”μ²­ μ‹ μ”μ—¬ ν¬μΈνΈλ” 0κ³Ό κ°™κ±°λ‚ μ»¤μ•Όν•λ‹¤.

- κ²°κ³Ό
  ![img.png](img/reservation-expiration-concurrencyTest.png)